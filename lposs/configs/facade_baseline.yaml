_base_: "default.yaml"
defaults:
  - _self_

seed: 42
model_name: FacadeLPOSS-baseline
output: "./outputs/facade_baseline"

model:
  type: FacadeLPOSS
  clip_backbone: maskclip
  vit_arch: vit_base
  vit_patch_size: 16
  enc_type_feats: "v"
  trainable_decode_head: true
  unfreeze_clip_backbone: false
  decode_head_dropout: 0.2
  gradual_unfreeze:
    stages:
      - epoch: 1
        patterns:
          - "backbone.visual.ln_post*"
          - "backbone.visual.transformer.resblocks.11*"
      - epoch: 4
        patterns:
          - "backbone.visual.transformer.resblocks.10*"
      - epoch: 7
        patterns:
          - "backbone.visual.proj*"
  lora:
    enabled: true
    rank: 4
    alpha: 8
    dropout: 0.1
    target_modules:
      - "backbone.visual.transformer.resblocks.10.mlp.c_fc"
      - "backbone.visual.transformer.resblocks.10.mlp.c_proj"
      - "backbone.visual.transformer.resblocks.11.mlp.c_fc"
      - "backbone.visual.transformer.resblocks.11.mlp.c_proj"
      - "decode_head.proj"
  prompt_templates:
    - "a detailed photo of {} on a building facade"
    - "close-up view showing {} on masonry"
prompt_descriptions:
  background:
    - "Plain surface with nothing special going on."
    - "Even look and color; normal joints or seams are fine."
    - "Ignore random stuff like shadows or passing objects."

  CRACK:
    - "A line where the surface split; thin or wide, any direction."
    - "Not regular seams or neat decorative lines."

  SPALLING:
    - "Outer layer has flaked off, showing what's beneath."
    - "Different from MISSING_ELEMENT: happens on the flat wall, not fancy pieces."

  DELAMINATION:
    - "Soft-edged patches that seem swollen or a different tone."
    - "Not the long streaks from running water."

  MISSING_ELEMENT:
    - "A piece of a decorative detail is gone, leaving a weird gap."
    - "Not the flat wall peeling."

  WATER_STAIN:
    - "Streaky marks from water running down, often under ledges or pipes."
    - "Not the puffy-looking patches."

  EFFLORESCENCE:
    - "White, powdery crust on the surface, common on brick or stone."
    - "Not paint or simple dust."

  CORROSION:
    - "Rusty spots or streaks around metal bits."
    - "Not just brown paint or a deliberate aged look."

  ORNAMENT_INTACT:
    - "Decorative piece is present and looks fine."
    - "Other issues nearby don’t mean this is damaged."

  REPAIRS:
    - "Patches or repainting that don’t match the rest; sometimes temporary covers."
    - "Not a full, even repaint."

  TEXT_OR_IMAGES:
    - "Added stuff like signs, numbers, graffiti, ads."
    - "Not the building’s own material pattern."

  optimisation:
    lr: 3.0e-5
    weight_decay: 5.0e-4
    ignore_index: 255
    scheduler:
      type: cosine
      min_lr: 1.0e-6
      warmup_epochs: 2
      t_max: ${training.max_epochs}

alpha: 0.95
gamma: 3.0
k: 400
sigma: 0.01
pix_dist_pow: 1.0
pixel_refine: true
tau: 0.01
r: 13

training:
  dataset:
    config: segmentation/configs/_base_/datasets/facade_damage.py
    data_root: ${oc.env:FACADE_DATA_ROOT, ./data/facade_damage}
    classes: null
    repeat_times: 1
    tile_mode: true
    recursive: true
  samples_per_gpu: 1
  val_samples_per_gpu: 1
  workers_per_gpu: 2
  max_epochs: 500
  val_interval: 1
  log_interval: 1
  checkpoint_dir: ${output}/checkpoints
  confusion_dir: ${output}/confusion_matrices

evaluate:
  task:
    - facade_damage
  facade_damage:
    config: segmentation/configs/_base_/datasets/facade_damage.py
    data_root: ${training.dataset.data_root}
